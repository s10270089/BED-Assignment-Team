<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CareConnect</title>
  <link rel="stylesheet" href="./css/styles.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=account_circle" />
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

</head>
<body>
  <header>
    <div class="container header-container">
      <img src="./assets/CareConnectblue.png" alt="CareConnect Logo" class="logo">
      <nav>
        <ul class="nav-list">
          <li><a href="./index.html">Home</a></li>
          <li class="dropdown">
            <a href="#features">Features</a>
            <ul class="dropdown-menu">
              <li><a href="./medications.html">Medication Manager</a></li>
              <li><a href="./bus.html">Live Bus Tracker</a></li>
              <li><a href="./login.html">User Login &amp; Signup</a></li>
              <li><a href="./shopping-list.html">Shopping List Manager</a></li>
              <li><a href="./emergencycontact.html">Emergency Quick-Dial</a></li>
              <li><a href="./checklist.html">Checklist Creator</a></li>
              <li><a href="./event-planner.html">Event Planner</a></li>
              <li><a href="./calendar.html">Activity Calendar</a></li>
              <li><a href="./dashboard.html">Overview Dashboard</a></li>
              <li><a href="./health-records.html">Health Records</a></li>
              <li><a href="./reminder.html">Reminders</a></li>
              <li><a href="./translation.html">Auto-Translation</a></li>
              <li><a href="./doctor-login.html">Doctor &amp; Caretaker Login</a></li>
              <li><a href="./profile.html">User Profile Manager</a></li>
              <li><a href="./workout.html">Workout Plan Organizer</a></li>
              <li><a href="./daily-log.html">Daily Log Tracker</a></li>
            </ul>
          </li>
          <li><a href="#about">About</a></li>
          <li><a href="#contact">Contact</a></li>
          <li><a href="./signup.html"><span class="material-symbols-outlined">account_circle</span></a></li>
        </ul>
      </nav>
    </div>
  </header>


<body>
<div class="reminders-page">
  <!-- Tasks Panel -->
<div class="tasks-panel">
  <h2>Tasks</h2>
<h3 class="toggle-header" data-label="Past" data-target="list-past">
  <span class="arrow">‚ñ∂</span> 
  <span class="label">Past</span> 
  (<span class="count" id="count-past">0</span>)
</h3>
<div class="task-list hidden" id="list-past"></div>

<h3 class="toggle-header" data-label="Today" data-target="list-today">
  <span class="arrow">‚ñ∂</span> 
  <span class="label">Today</span> 
  (<span class="count" id="count-today">0</span>)
</h3>
<div class="task-list hidden" id="list-today"></div>

<h3 class="toggle-header" data-label="Tomorrow" data-target="list-tomorrow">
  <span class="arrow">‚ñ∂</span> 
  <span class="label">Tomorrow</span> 
  (<span class="count" id="count-tomorrow">0</span>)
</h3>
<div class="task-list hidden" id="list-tomorrow"></div>

<h3 class="toggle-header" data-label="Upcoming" data-target="list-upcoming">
  <span class="arrow">‚ñ∂</span> 
  <span class="label">Upcoming</span> 
  (<span class="count" id="count-upcoming">0</span>)
</h3>
<div class="task-list hidden" id="list-upcoming"></div>

  <div class="task-input">
    <input type="text" id="new-event-title" placeholder="Event Title" />
    <input type="text" id="new-event-description" placeholder="Event Description" />
    <input type="text" id="new-event-location" placeholder="Location" />
    <input type="datetime-local" id="new-event-start-datetime" />
    <input type="datetime-local" id="new-event-end-datetime" />
    <input type="text" id="new-event-invitees" placeholder="Invitees (comma separated user IDs)" />
    <button id="addNewEvent">Add Event</button>
    <button id="cancelEditEvent" style="display: none;">Cancel Edit</button>
    <button id="deleteEvent" style="display: none;">Delete Event</button>
  </div>  
</div>

  <!-- Calendar Panel -->
  <div class="calendar-panel">
    <div id="calendar"></div>
  </div>
</div>

<script>
function formatDateLocal(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-based
  const day = String(date.getDate()).padStart(2, '0');
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');

  return `${year}-${month}-${day}T${hours}:${minutes}`;
}

    let calendar;  // Global variable

    // Ensuring the code runs after the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', async function () {

      const userid = localStorage.getItem('user_id');
      const token = localStorage.getItem('token');
      console.log("user: ", userid);

      if (!token) {
        alert('You need to be logged in to access reminders.');
        window.location.href = '/login.html';
        return;
      }

      // Load tasks panel and calendar
      try {
        await loadTasksPanel();  // Load tasks panel first
      } catch (error) {
        console.error('Error loading tasks panel:', error);
      }

      const calendarEl = document.getElementById('calendar');
      try {
        const res = await fetch('/events', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
          }
        });

        if (!res.ok) {
          throw new Error('Unauthorized request');
        }

        const data = await res.json();
        const eventsData = data.events;  // <-- Extract events array

        const events = eventsData.map(e => ({
          id: e.event_id,
          title: e.title,
          start: e.event_start_time,
          end: e.event_end_time,
          allDay: false,
          extendedProps: {
            description: e.description,
            location: e.location,
            invitees: e.invitees
          }
        }));

//        console.log("Events data fetched for calendar:", eventsData);
//        alert("Events data fetched for calendar: " + JSON.stringify(events, null, 2));

        calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'timeGridDay',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay',
          },
          events,
          editable: true,

          eventContent: function(arg) {
              const viewType = arg.view.type;  // 'dayGridMonth', 'timeGridWeek', etc.
              const title = arg.event.title;
              const description = arg.event.extendedProps.description;
              const location = arg.event.extendedProps.location;
            // Only show location & description in Week & Day view
            if (viewType === 'dayGridMonth') {
              // Month View: Only show title
              alert("Month View: Only show title");
              return { html: `<div class="fc-event-title">${title}</div>` };
            } else {
              // Week/Day View: Show Title, Location, Description
              return {
                html: `
                  <div class="fc-event-title">${title}</div>
                  <div class="fc-event-location">${location || ''}</div>
                  <div class="fc-event-desc">${description || ''}</div>
                `
              };
            }
            return { html: innerHTML };
          },

          eventClick: function(info) {
            const event = info.event;

            // Corrected field IDs ‚¨áÔ∏è
            document.getElementById('new-event-title').value = event.title || '';
            document.getElementById('new-event-description').value = event.extendedProps.description || '';
            document.getElementById('new-event-location').value = event.extendedProps.location || '';
            startDateTime = new Date(event.start);
            endDateTime = event.end ? new Date(event.end) : null;

            //alert("startDateTime: " + startDateTime + ", endDateTime: " + endDateTime);

            // Set the datetime-local input values

            document.getElementById('new-event-start-datetime').value = formatDateLocal(event.start);
            document.getElementById('new-event-end-datetime').value = event.end ? formatDateLocal(event.end) : '';
//            document.getElementById('new-event-start-datetime').value = event.start;
//            document.getElementById('new-event-end-datetime').value = event.end;
            document.getElementById('new-event-invitees').value = event.extendedProps.invitees || '';

            // Change Button Text
            const addButton = document.getElementById('addNewEvent');
            addButton.textContent = 'Update Event';
            addButton.setAttribute('data-update-id', event.id);
//            alert("Event ID: " + event.id + ", Title: " + event.title);

            // Show Cancel and Delete buttons
            document.getElementById('cancelEditEvent').style.display = 'inline-block';
            document.getElementById('deleteEvent').style.display = 'inline-block';
          },
          // eventDrop: async function(info) {
          //   const updatedTime = info.event.start.toISOString();
          //   await fetch(`/events/${info.event.id}/update`, {
          //     method: 'POST',
          //     headers: {'Content-Type': 'application/json'},
          //     body: JSON.stringify({
          //       message: info.event.title,
          //       reminder_time: updatedTime,
          //       is_completed: 0
          //     })
          //   });
          // },
          eventContent: function(arg) {
            const title = arg.event.title;
            const description = arg.event.extendedProps.description || '';
            const location = arg.event.extendedProps.location || '';

            return {
              html: `
                <div class="fc-event-title">${title}</div>
                <div class="fc-event-location" style="font-size: 0.75em;">üìç ${location}</div>
                <div class="fc-event-desc" style="font-size: 0.75em;">üìù ${description}</div>
              `
            };
          }
        });

        calendar.render();
        await refreshCalendar();


      } catch (err) {
        console.error('Error loading reminders:', err);
        alert('Failed to load reminders');
      }

      // Load tasks panel
      async function loadTasksPanel() {
        let pastCount = 0, todayCount = 0, tomorrowCount = 0, upcomingCount = 0;
        try {
          const res = await fetch('/events', {
            headers: {
              'Authorization': `Bearer ${token}`,
            }
          });

          if (!res.ok) {
            throw new Error('Unauthorized request');
          }

          const events = await res.json();

          const listPast = document.getElementById('list-past');
          const listToday = document.getElementById('list-today');
          const listTomorrow = document.getElementById('list-tomorrow');
          const listUpcoming = document.getElementById('list-upcoming');
        
          const now = new Date();
          const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          const tomorrow = new Date(today);
          tomorrow.setDate(today.getDate() + 1);
          //const now = new Date();
          //const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          //const startOfTomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);

          listPast.innerHTML = '';
          listToday.innerHTML = '';
          listTomorrow.innerHTML = '';
          listUpcoming.innerHTML = '';
          console.log("Events fetched:", events);
          const eventarray = events.events;

          eventarray.forEach(event => {
            date = new Date(event.event_start_time.replace("T", " ")); // Convert to local time

            //alert("Event Date: " + date);

            const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const taskEl = document.createElement('div');
            //taskEl.className = `task-item${reminder.is_completed ? ' completed' : ''}`;
            taskEl.className = `task-item`;
            taskEl.innerHTML = `
                <div class="task-content">
                <span class="task-title">${event.title}</span>
                <div class="task-meta">
                    <span class="task-tag">${timeStr}</span>
                </div>
                </div>
            `;

            const dateOnly = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            //const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            //const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            if (dateOnly < today) {
                listPast.appendChild(taskEl);
                pastCount++;
            } else if (dateOnly.getTime() === today.getTime()) {
                listToday.appendChild(taskEl);
                todayCount++;
            } else if (dateOnly.getTime() === tomorrow.getTime()) {
                listTomorrow.appendChild(taskEl);
                tomorrowCount++;
            } else {
                listUpcoming.appendChild(taskEl);
                upcomingCount++;
            }
            });

        } catch (err) {
          console.error('Error loading tasks panel', err);
        }
      }

      // Add new event function
      const addNewEvent = document.getElementById('addNewEvent');
      if (addNewEvent) {
        addNewEvent.addEventListener('click', async function () {
          const eventId = addNewEvent.getAttribute('data-update-id');  // Check if updating

          const title = document.getElementById('new-event-title').value.trim();
          const description = document.getElementById('new-event-description').value.trim();
          const location = document.getElementById('new-event-location').value.trim();
          const startDatetime = document.getElementById('new-event-start-datetime').value;
          const endDatetime = document.getElementById('new-event-end-datetime').value;
          const inviteesInput = document.getElementById('new-event-invitees').value.trim().split(',').map(id => id.trim());
          const invitees = inviteesInput.toString();

          //console.log("startDatetime:", startDatetime, "endDatetime:", endDatetime);

          const [datePart, timePart] = startDatetime.split('T');

          if (!title || !description || !location || !startDatetime || !endDatetime) {
            alert('Please fill in all fields. (Invitees can be left empty)');
            return;
          }

          try {
            let url = '/events';
            let method = 'POST';
            if (eventId) {
              url = `/events/${eventId}`;  // <-- Update route when editing
              method = 'PUT';
            }

            const response = await fetch(url, {
              method: method,
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
              },
              body: JSON.stringify({
                user_id: "",  // You'll need to fill this in based on logged-in user
                title: title,
                description: description,
                location: location,
                date: datePart,
                event_start_time: startDatetime,
                event_end_time: endDatetime,
                invitees: invitees
              })
            });

            if (!response.ok) {
              const error = await response.json();
              console.error('Error response:', error);
              throw new Error(error.message || 'Failed to create/update event');
            }

            // Reset form & state
            document.getElementById('new-event-title').value = '';
            document.getElementById('new-event-description').value = '';
            document.getElementById('new-event-location').value = '';
            document.getElementById('new-event-start-datetime').value = '';
            document.getElementById('new-event-end-datetime').value = '';
            document.getElementById('new-event-invitees').value = '';
            addNewEvent.removeAttribute('data-update-id');
            addNewEvent.textContent = 'Add Event';  // Reset button text after update

            await loadTasksPanel();  // Refresh the task panel
            await refreshCalendar();  // Refresh the calendar




          } catch (err) {
            console.error('Error creating/updating event:', err);
            alert('Error adding/updating event: ' + err.message);
          }
        });
      }


      // Toggle task list visibility
      document.querySelectorAll('.toggle-header').forEach(header => {
        header.addEventListener('click', function () {
          const targetId = this.getAttribute('data-target');
          const list = document.getElementById(targetId);

          if (!list) {
            console.log(`No list found for target: ${targetId}`);
            return;
          }

          list.classList.toggle('hidden');  // Toggle the 'hidden' class

          const arrow = this.querySelector('.arrow');
          const isCollapsed = list.classList.contains('hidden');
          arrow.textContent = isCollapsed ? '‚ñ∂' : '‚ñº';  // Toggle the arrow symbol
        });
      });
      async function refreshCalendar() {
      const res = await fetch('/events', { headers: { 'Authorization': `Bearer ${token}` } });
      const data = await res.json();
      const eventsData = data.events;

      const formattedEvents = eventsData.map(e => ({
        id: e.event_id,
        title: e.title,
        description: e.description,
        location: e.location,
        start: e.event_start_time,
        end: e.event_end_time,
        invitees: e.invitees,
        allDay: false
      }));
      

      document.getElementById('cancelEditEvent').addEventListener('click', function() {
        // Clear form fields
        document.getElementById('new-event-title').value = '';
        document.getElementById('new-event-description').value = '';
        document.getElementById('new-event-location').value = '';
        document.getElementById('new-event-start-datetime').value = '';
        document.getElementById('new-event-end-datetime').value = '';
        document.getElementById('new-event-invitees').value = '';

        // Reset button text and remove update ID
        const addButton = document.getElementById('addNewEvent');
        addButton.textContent = 'Add Event';
        addButton.removeAttribute('data-update-id');

        // Hide Cancel and Delete buttons
        document.getElementById('cancelEditEvent').style.display = 'none';
        document.getElementById('deleteEvent').style.display = 'none';
      });


      document.getElementById('deleteEvent').addEventListener('click', async function() {
    const deleteButton = this;
    const eventId = document.getElementById('addNewEvent').getAttribute('data-update-id');

    if (!eventId) {
        alert("No event selected to delete.");
        return;
    }

    if (!confirm("Are you sure you want to delete this event?")) {
        return;
    }

    console.log("Deleting event with ID:", eventId);
    deleteButton.disabled = true;  // Disable button to prevent double clicks

    try {
        const res = await fetch(`/events/${eventId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`,
            }
        });

        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.message || 'Failed to delete event');
        }

        alert('Event deleted successfully.');

        // REMOVE from FullCalendar UI immediately
        calendar.getEventById(eventId).remove();

        // Clear form and reset button states
        document.getElementById('cancelEditEvent').click();

        // Refresh Panels (Task List)
await loadTasksPanel();

    } catch (err) {
        console.error('Error deleting event:', err);
        alert('Failed to delete event: ' + err.message);
    } finally {
        deleteButton.disabled = false;  // Re-enable button after operation completes
    }



});


    }

    });
  </script>
</body>
</html>
